<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</title>
  <link rel="stylesheet" href="/liff/css/style.css">
  <style>
    .current-info { background:#E3F2FD; border-radius:10px; padding:16px; margin-bottom:16px; }
    .current-info .label { color:#999; font-size:0.85rem; }
    .current-info .value { font-weight:600; margin-bottom:8px; }
    .btn-danger { background:#E53935; color:#fff; border:none; padding:12px; border-radius:8px; font-size:1rem; width:100%; cursor:pointer; margin-top:8px; }
    .btn-outline { background:#fff; color:#1565C0; border:2px solid #1565C0; padding:12px; border-radius:8px; font-size:1rem; width:100%; cursor:pointer; margin-top:8px; }
  </style>
</head>
<body>
  <div class="container">
    <h1><img src="logo-ppnr.png" alt="" style="width:36px;height:36px;vertical-align:middle;border-radius:50%;margin-right:6px;">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</h1>
    <div id="loading" class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</div>

    <div id="existingSection" class="hidden">
      <div class="current-info">
        <div class="label">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</div>
        <div class="value" id="curName"></div>
        <div class="label">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</div>
        <div class="value" id="curPosition"></div>
        <div class="label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</div>
        <div class="value" id="curPhone"></div>
        <div class="label">‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏Å‡∏≠‡∏á</div>
        <div class="value" id="curDept"></div>
      </div>
      <button class="btn-outline" type="button" onclick="showEditForm()">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <button class="btn-danger" type="button" onclick="doUnregister()">üóëÔ∏è ‡∏•‡∏ö‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
    </div>

    <div id="formSection" class="hidden">
      <div class="form-group">
        <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏à‡∏£‡∏¥‡∏á) <span style="color:#F44336">*</span></label>
        <input type="text" id="name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ">
        <small style="color:#999;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏à‡∏£‡∏¥‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</small>
      </div>
      <div class="form-group">
        <label>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
        <input type="text" id="position" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏ü‡πâ‡∏≤">
      </div>
      <div class="form-group">
        <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå <span style="color:#F44336">*</span></label>
        <input type="tel" id="phone" placeholder="089-123-4567">
      </div>
      <div class="form-group">
        <label>‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏Å‡∏≠‡∏á <span style="color:#F44336">*</span></label>
        <select id="department"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≠‡∏á --</option></select>
      </div>
      <button id="submitBtn" class="btn btn-primary" type="button">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
    <div id="result" class="result hidden"></div>
  </div>

  <script>
    const token = new URLSearchParams(window.location.search).get('t') || '';
    const H = { 'ngrok-skip-browser-warning': '1' };
    let lineUserId = '';
    let departments = [];
    let existingOfficer = null;

    async function init() {
      try {
        // verify token
        const authRes = await fetch(`/api/auth/verify?token=${token}`, { headers: H });
        const auth = await authRes.json();
        if (!auth.success) {
          showError(auth.error || '‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå /ppnr ‡πÉ‡∏´‡∏°‡πà');
          return;
        }
        lineUserId = auth.lineUserId;
        document.getElementById('loading').classList.add('hidden');

        // Load departments
        const deptRes = await fetch('/api/officers/departments/list', { headers: H });
        departments = await deptRes.json();
        const select = document.getElementById('department');
        departments.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d.id;
          opt.textContent = d.name;
          select.appendChild(opt);
        });

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
        const officerRes = await fetch(`/api/officers/${lineUserId}`, { headers: H });
        if (officerRes.ok) {
          existingOfficer = await officerRes.json();
          showExisting();
        } else {
          document.getElementById('formSection').classList.remove('hidden');
        }
      } catch (err) { showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message); }
    }

    function showExisting() {
      const dept = departments.find(d => d.id === existingOfficer.departmentId);
      document.getElementById('curName').textContent = existingOfficer.name;
      document.getElementById('curPosition').textContent = existingOfficer.position || '-';
      document.getElementById('curPhone').textContent = existingOfficer.phone;
      document.getElementById('curDept').textContent = dept ? dept.name : '-';
      document.getElementById('existingSection').classList.remove('hidden');
      document.getElementById('formSection').classList.add('hidden');
    }

    function showEditForm() {
      document.getElementById('name').value = existingOfficer.name;
      document.getElementById('position').value = existingOfficer.position || '';
      document.getElementById('phone').value = existingOfficer.phone;
      document.getElementById('department').value = existingOfficer.departmentId;
      document.getElementById('existingSection').classList.add('hidden');
      document.getElementById('formSection').classList.remove('hidden');
    }

    async function doUnregister() {
      if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô?')) return;
      const res = await fetch('/api/officers/unregister', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...H },
        body: JSON.stringify({ lineUserId }),
      });
      const data = await res.json();
      if (data.success) {
        existingOfficer = null;
        document.getElementById('existingSection').classList.add('hidden');
        document.getElementById('result').innerHTML = 'üóëÔ∏è ‡∏•‡∏ö‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!';
        document.getElementById('result').className = 'result success';
        document.getElementById('result').classList.remove('hidden');
        document.getElementById('name').value = '';
        document.getElementById('position').value = '';
        document.getElementById('phone').value = '';
        document.getElementById('department').value = '';
        document.getElementById('formSection').classList.remove('hidden');
      }
    }

    function showError(msg) {
      document.getElementById('loading').classList.add('hidden');
      const r = document.getElementById('result');
      r.innerHTML = msg; r.className = 'result error'; r.classList.remove('hidden');
    }

    document.getElementById('submitBtn').addEventListener('click', async () => {
      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const departmentId = document.getElementById('department').value;
      if (!name) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏à‡∏£‡∏¥‡∏á'); return; }
      if (name.length < 4) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); return; }
      if (!phone) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£'); return; }
      if (!departmentId) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≠‡∏á'); return; }

      const btn = document.getElementById('submitBtn');
      btn.disabled = true; btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

      const res = await fetch('/api/officers/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...H },
        body: JSON.stringify({ lineUserId, name, position: document.getElementById('position').value.trim(), phone, departmentId }),
      });
      const data = await res.json();
      if (data.success) {
        const dept = departments.find(d => d.id === Number(departmentId));
        document.getElementById('result').innerHTML = `‚úÖ ${existingOfficer ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô'}‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!<br><b>${name}</b> ‚Äî ${dept?.name || ''}`;
        document.getElementById('result').className = 'result success';
        document.getElementById('result').classList.remove('hidden');
        document.getElementById('formSection').classList.add('hidden');
      } else {
        alert('‚ùå ' + (data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'));
        btn.disabled = false; btn.textContent = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
      }
    });

    init();
  </script>
</body>
</html>
