<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</title>
  <link rel="stylesheet" href="/liff/css/style.css">
</head>
<body>
  <div class="container">
    <h1>üìù ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</h1>
    <div id="loading" class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>

    <div id="formSection" class="hidden">
      <div class="form-group">
        <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
        <input type="text" id="name" placeholder="‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ">
      </div>
      <div class="form-group">
        <label>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
        <input type="text" id="position" placeholder="‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏ü‡πâ‡∏≤">
      </div>
      <div class="form-group">
        <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
        <input type="tel" id="phone" placeholder="089-123-4567">
      </div>
      <div class="form-group">
        <label>‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏Å‡∏≠‡∏á</label>
        <select id="department">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≠‡∏á --</option>
        </select>
      </div>
      <button id="submitBtn" class="btn btn-primary" type="button">üíæ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
    </div>

    <div id="result" class="result hidden"></div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    let lineUserId = '';

    async function init() {
      try {
        const config = await fetch('/api/config').then(r => r.json());

        if (!config.liffId) {
          showError('‡πÑ‡∏°‡πà‡∏û‡∏ö LIFF ID');
          return;
        }

        await liff.init({ liffId: config.liffId, withLoginOnExternalBrowser: true });

        if (!liff.isLoggedIn()) {
          // ‡∏Å‡∏≥‡∏•‡∏±‡∏á redirect ‡πÑ‡∏õ login ‡∏≠‡∏¢‡∏π‡πà ‚Äî ‡∏ñ‡πâ‡∏≤‡∏ß‡∏ô‡∏ã‡πâ‡∏≥ 3 ‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î
          const attempts = Number(sessionStorage.getItem('liff_login_attempts') || 0);
          if (attempts >= 2) {
            sessionStorage.removeItem('liff_login_attempts');
            showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ login ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏ä‡∏ó LINE');
            return;
          }
          sessionStorage.setItem('liff_login_attempts', String(attempts + 1));
          return;
        }

        // Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Äî reset counter
        sessionStorage.removeItem('liff_login_attempts');

        const profile = await liff.getProfile();
        lineUserId = profile.userId;
        document.getElementById('name').value = profile.displayName || '';

        // Load departments
        const res = await fetch('/api/officers/departments/list');
        const depts = await res.json();
        const select = document.getElementById('department');
        depts.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d.id;
          opt.textContent = d.name;
          select.appendChild(opt);
        });

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('formSection').classList.remove('hidden');

      } catch (err) {
        showError('Error: ' + (err.message || JSON.stringify(err)));
      }
    }

    function showError(msg) {
      document.getElementById('loading').classList.add('hidden');
      const result = document.getElementById('result');
      result.innerHTML = msg;
      result.className = 'result error';
      result.classList.remove('hidden');
    }

    // ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‚Äî ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ form submit ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô reload
    document.getElementById('submitBtn').addEventListener('click', async () => {
      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const departmentId = document.getElementById('department').value;

      if (!name) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠'); return; }
      if (!phone) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£'); return; }
      if (!departmentId) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≠‡∏á'); return; }

      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô...';

      try {
        const res = await fetch('/api/officers/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            lineUserId,
            name,
            position: document.getElementById('position').value.trim(),
            phone,
            departmentId,
          }),
        });
        const data = await res.json();

        const result = document.getElementById('result');
        result.classList.remove('hidden');
        document.getElementById('formSection').classList.add('hidden');

        if (data.success) {
          result.innerHTML = '‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';
          result.className = 'result success';
          setTimeout(() => { try { liff.closeWindow(); } catch(e) {} }, 1500);
        } else {
          result.innerHTML = '‚ùå ' + (data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
          result.className = 'result error';
          document.getElementById('formSection').classList.remove('hidden');
          btn.disabled = false;
          btn.textContent = 'üíæ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô';
        }
      } catch (err) {
        showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
      }
    });

    init();
  </script>
</body>
</html>
