<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</title>
  <link rel="stylesheet" href="/liff/css/style.css">
</head>
<body>
  <div class="container">
    <h1><img src="logo-ppnr.png" alt="" style="width:36px;height:36px;vertical-align:middle;border-radius:50%;margin-right:6px;">‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</h1>
    <p id="officerInfo" style="text-align:center;color:#2196F3;font-weight:bold;margin-bottom:12px;"></p>
    <div id="taskList" class="task-list"><p class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</p></div>
    <div id="closeForm" class="hidden">
      <h2 id="selectedTaskRef"></h2>
      <div class="form-group">
        <label>‡∏ú‡∏•‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô</label>
        <div class="radio-group">
          <label class="radio-card success"><input type="radio" name="status" value="completed"><span>‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span></label>
          <label class="radio-card warning"><input type="radio" name="status" value="waiting"><span>‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô</span></label>
          <label class="radio-card danger"><input type="radio" name="status" value="failed"><span>‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span></label>
        </div>
      </div>
      <div id="noteSection" class="form-group hidden">
        <label id="noteLabel">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
        <textarea id="note" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà, ‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏¢..."></textarea>
      </div>
      <div class="form-group">
        <label>üì∑ ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏ú‡∏•‡∏á‡∏≤‡∏ô (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
        <input type="file" id="photoInput" accept="image/*" capture="environment" style="margin-top:6px;">
        <div id="photoPreview" style="margin-top:8px;"></div>
      </div>
      <button class="btn btn-primary" type="button" onclick="closeTask()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•</button>
    </div>
    <div id="result" class="result hidden"></div>
  </div>
  <script>
    const token = new URLSearchParams(window.location.search).get('t') || '';
    const H = { 'ngrok-skip-browser-warning': '1' };
    let officerId = null;
    let selectedComplaintId = null;
    let tasks = [];
    let photoBase64 = null;

    document.getElementById('photoInput').addEventListener('change', (e) => {
      const file = e.target.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        photoBase64 = ev.target.result;
        document.getElementById('photoPreview').innerHTML = `<img src="${photoBase64}" style="width:100%;max-height:200px;object-fit:cover;border-radius:8px;">`;
      };
      reader.readAsDataURL(file);
    });

    async function init() {
      try {
        const authRes = await fetch(`/api/auth/verify?token=${token}`, { headers: H });
        const auth = await authRes.json();
        if (!auth.success || !auth.officerId) {
          showError(auth.error || '‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå /ppnr ‡πÉ‡∏´‡∏°‡πà'); return;
        }
        officerId = auth.officerId;
        const officerRes = await fetch(`/api/officers/by-id/${officerId}`, { headers: H });
        if (officerRes.ok) {
          const officer = await officerRes.json();
          document.getElementById('officerInfo').textContent = `üë∑ ${officer.name}`;
        }
        const res = await fetch(`/api/tasks/dispatched/${officerId}`, { headers: H });
        tasks = await res.json();
        renderTasks();
      } catch (err) { showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message); }
    }

    function showError(msg) {
      document.getElementById('taskList').innerHTML = `<p style="color:#C62828;text-align:center;padding:20px;">${msg}</p>`;
    }
    function renderTasks() {
      const c = document.getElementById('taskList');
      if (tasks.length === 0) { c.innerHTML = '<p class="empty">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏õ‡∏¥‡∏î ‚ú®</p>'; return; }
      c.innerHTML = tasks.map(t => `
        <div class="task-card clickable" onclick="selectTask(${t.id},'${t.refId}')">
          <div class="task-info">
            <div class="task-ref">${t.refId}</div>
            <div class="task-issue">${t.issue}</div>
            <div class="task-location">üìç ${t.location || '-'}</div>
          </div>
        </div>`).join('');
    }
    function selectTask(id, refId) {
      selectedComplaintId = id;
      document.getElementById('selectedTaskRef').textContent = refId;
      document.getElementById('closeForm').classList.remove('hidden');
      document.getElementById('taskList').classList.add('hidden');
    }
    document.querySelectorAll('input[name="status"]').forEach(r => {
      r.addEventListener('change', (e) => {
        const ns = document.getElementById('noteSection');
        if (e.target.value === 'completed') { ns.classList.add('hidden'); }
        else { ns.classList.remove('hidden');
          document.getElementById('noteLabel').textContent = e.target.value === 'waiting' ? '‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡∏£‡∏≠' : '‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
        }
      });
    });
    let isSubmitting = false;
    async function closeTask() {
      if (isSubmitting) return; // ‡∏Å‡∏±‡∏ô double click
      const status = document.querySelector('input[name="status"]:checked')?.value;
      if (!status) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏•‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô'); return; }
      isSubmitting = true;
      const btn = document.querySelector('.btn-primary');
      btn.disabled = true; btn.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      const note = document.getElementById('note').value;
      let photoUrl;
      if (photoBase64) {
        try {
          const u = await fetch('/api/uploads/image',{method:'POST',headers:{'Content-Type':'application/json',...H},body:JSON.stringify({image:photoBase64})});
          const ud = await u.json(); if (ud.success) photoUrl = ud.path;
        } catch(e) { console.error('Upload failed:',e); }
      }
      try {
        const res = await fetch('/api/tasks/close',{method:'POST',headers:{'Content-Type':'application/json',...H},
          body:JSON.stringify({complaintId:selectedComplaintId,resultStatus:status,note:note||undefined,photoUrl})});
        const data = await res.json();
        const result = document.getElementById('result');
        result.classList.remove('hidden'); document.getElementById('closeForm').classList.add('hidden');
        if (data.success) {
          const st = status==='completed'?'‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à':status==='waiting'?'‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô':'‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
          result.innerHTML = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!<br>${data.refId}: ${st}`;
          result.className = 'result success';
        } else { result.innerHTML = '‚ùå '+(data.error||'‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'); result.className = 'result error'; }
      } catch(e) {
        btn.disabled = false; btn.textContent = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•'; isSubmitting = false;
      }
    }
    init();
  </script>
</body>
</html>
