<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</title>
  <link rel="stylesheet" href="/liff/css/style.css">
</head>
<body>
  <div class="container">
    <h1>üìã ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</h1>
    <p id="officerInfo" style="text-align:center;color:#2196F3;font-weight:bold;margin-bottom:12px;"></p>
    <div id="taskList" class="task-list">
      <p class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
    </div>
    <div id="closeForm" class="hidden">
      <h2 id="selectedTaskRef"></h2>
      <div class="form-group">
        <label>‡∏ú‡∏•‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô</label>
        <div class="radio-group">
          <label class="radio-card success">
            <input type="radio" name="status" value="completed">
            <span>‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>
          </label>
          <label class="radio-card warning">
            <input type="radio" name="status" value="waiting">
            <span>‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô</span>
          </label>
          <label class="radio-card danger">
            <input type="radio" name="status" value="failed">
            <span>‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>
          </label>
        </div>
      </div>
      <div id="noteSection" class="form-group hidden">
        <label id="noteLabel">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
        <textarea id="note" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà, ‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏¢..."></textarea>
      </div>
      <div class="form-group">
        <label>üì∑ ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏ú‡∏•‡∏á‡∏≤‡∏ô (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
        <input type="file" id="photoInput" accept="image/*" capture="environment" style="margin-top:6px;">
        <div id="photoPreview" style="margin-top:8px;"></div>
      </div>
      <button class="btn btn-primary" onclick="closeTask()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•</button>
    </div>
    <div id="result" class="result hidden"></div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    let officerId = null;
    let selectedComplaintId = null;
    let tasks = [];
    let photoBase64 = null;

    // Preview photo
    document.getElementById('photoInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        photoBase64 = ev.target.result;
        document.getElementById('photoPreview').innerHTML =
          `<img src="${photoBase64}" style="width:100%;max-height:200px;object-fit:cover;border-radius:8px;">`;
      };
      reader.readAsDataURL(file);
    });

    async function init() {
      try {
        const config = await fetch('/api/config').then(r => r.json());
        await liff.init({ liffId: config.liffId, withLoginOnExternalBrowser: true });

        if (!liff.isLoggedIn()) {
          return;
        }

        // ‡∏î‡∏∂‡∏á officer ‡∏à‡∏≤‡∏Å LINE profile
        const profile = await liff.getProfile();
        const officerRes = await fetch(`/api/officers/${profile.userId}`);
        if (!officerRes.ok) {
          showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô ‡∏û‡∏¥‡∏°‡∏û‡πå /‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°');
          return;
        }
        const officer = await officerRes.json();
        officerId = officer.id;
        document.getElementById('officerInfo').textContent = `üë∑ ${officer.name}`;

        const res = await fetch(`/api/tasks/dispatched/${officerId}`);
        tasks = await res.json();
        renderTasks();
      } catch (err) {
        showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
      }
    }

    function showError(msg) {
      document.getElementById('taskList').innerHTML = `<p class="error" style="color:#C62828;text-align:center;padding:20px;">${msg}</p>`;
    }

    function renderTasks() {
      const container = document.getElementById('taskList');
      if (tasks.length === 0) {
        container.innerHTML = '<p class="empty">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏õ‡∏¥‡∏î ‚ú®</p>';
        return;
      }

      container.innerHTML = tasks.map(t => `
        <div class="task-card clickable" onclick="selectTask(${t.id}, '${t.refId}')">
          <div class="task-info">
            <div class="task-ref">${t.refId}</div>
            <div class="task-issue">${t.issue}</div>
            <div class="task-location">üìç ${t.location || '-'}</div>
          </div>
        </div>
      `).join('');
    }

    function selectTask(id, refId) {
      selectedComplaintId = id;
      document.getElementById('selectedTaskRef').textContent = refId;
      document.getElementById('closeForm').classList.remove('hidden');
      document.getElementById('taskList').classList.add('hidden');
    }

    // Show/hide note based on status
    document.querySelectorAll('input[name="status"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        const noteSection = document.getElementById('noteSection');
        const noteLabel = document.getElementById('noteLabel');
        if (e.target.value === 'completed') {
          noteSection.classList.add('hidden');
        } else {
          noteSection.classList.remove('hidden');
          noteLabel.textContent = e.target.value === 'waiting' ? '‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡∏£‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà)' : '‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏¢)';
        }
      });
    });

    async function closeTask() {
      const status = document.querySelector('input[name="status"]:checked')?.value;
      if (!status) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏•‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô');
        return;
      }

      const note = document.getElementById('note').value;
      let photoUrl = undefined;

      // ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
      if (photoBase64) {
        try {
          const uploadRes = await fetch('/api/uploads/image', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: photoBase64 }),
          });
          const uploadData = await uploadRes.json();
          if (uploadData.success) {
            photoUrl = uploadData.path;
          }
        } catch (e) {
          console.error('Upload failed:', e);
        }
      }

      const res = await fetch('/api/tasks/close', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          complaintId: selectedComplaintId,
          resultStatus: status,
          note: note || undefined,
          photoUrl: photoUrl || undefined,
        }),
      });
      const data = await res.json();

      const result = document.getElementById('result');
      result.classList.remove('hidden');
      document.getElementById('closeForm').classList.add('hidden');
      if (data.success) {
        const statusText = status === 'completed' ? '‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : status === 'waiting' ? '‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô' : '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
        result.innerHTML = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!<br>${data.refId}: ${statusText}`;
        result.className = 'result success';
        setTimeout(() => { if (liff.isInClient()) liff.closeWindow(); }, 2000);
      } else {
        result.innerHTML = '‚ùå ' + (data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
        result.className = 'result error';
      }
    }

    init();
  </script>
</body>
</html>
