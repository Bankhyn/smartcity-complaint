<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏≠‡∏≠‡∏Å‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</title>
  <link rel="stylesheet" href="/liff/css/style.css">
</head>
<body>
  <div class="container">
    <h1><img src="logo-ppnr.png" alt="" style="width:36px;height:36px;vertical-align:middle;border-radius:50%;margin-right:6px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</h1>
    <p id="deptName" style="text-align:center;color:#2196F3;font-weight:bold;margin-bottom:12px;"></p>
    <div id="taskList" class="task-list"><p class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</p></div>
    <button id="dispatchBtn" class="btn btn-primary hidden" type="button" onclick="doDispatch()">
      ‚úÖ ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (<span id="selectedCount">0</span> ‡∏á‡∏≤‡∏ô)
    </button>
    <div id="result" class="result hidden"></div>
  </div>
  <script>
    const token = new URLSearchParams(window.location.search).get('t') || '';
    const H = { 'ngrok-skip-browser-warning': '1' };
    let officerId = null;
    let tasks = [];

    async function init() {
      try {
        const authRes = await fetch(`/api/auth/verify?token=${token}`, { headers: H });
        const auth = await authRes.json();
        if (!auth.success || !auth.officerId) {
          showError(auth.error || '‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå /ppnr ‡πÉ‡∏´‡∏°‡πà'); return;
        }
        officerId = auth.officerId;

        const deptRes = await fetch('/api/officers/departments/list', { headers: H });
        const officerRes = await fetch(`/api/officers/by-id/${officerId}`, { headers: H });
        if (deptRes.ok && officerRes.ok) {
          const officer = await officerRes.json();
          const depts = await deptRes.json();
          const dept = depts.find(d => d.id === officer.departmentId);
          if (dept) document.getElementById('deptName').textContent = `üè¢ ${dept.name}`;
        }
        const res = await fetch(`/api/tasks/pending/${officerId}`, { headers: H });
        tasks = await res.json();
        renderTasks();
      } catch (err) { showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message); }
    }

    function showError(msg) {
      document.getElementById('taskList').innerHTML = `<p style="color:#C62828;text-align:center;padding:20px;">${msg}</p>`;
    }
    function renderTasks() {
      const c = document.getElementById('taskList');
      if (tasks.length === 0) { c.innerHTML = '<p class="empty">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ ‚ú®</p>'; return; }
      c.innerHTML = tasks.map(t => `
        <label class="task-card">
          <input type="checkbox" value="${t.id}" onchange="updateCount()">
          <div class="task-info">
            <div class="task-ref">${t.refId}</div>
            <div class="task-issue">${t.issue}</div>
            <div class="task-location">üìç ${t.location || '-'}</div>
            <div class="task-contact">üë§ ${t.contactName || '-'} ${t.contactPhone ? 'üìû '+t.contactPhone : ''}</div>
          </div>
        </label>`).join('');
      document.getElementById('dispatchBtn').classList.remove('hidden');
    }
    function updateCount() {
      document.getElementById('selectedCount').textContent = document.querySelectorAll('.task-card input:checked').length;
    }
    async function doDispatch() {
      const ids = Array.from(document.querySelectorAll('.task-card input:checked')).map(el => Number(el.value));
      if (ids.length === 0) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏á‡∏≤‡∏ô'); return; }
      const btn = document.getElementById('dispatchBtn');
      btn.disabled = true; btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';
      const res = await fetch('/api/tasks/dispatch', {
        method:'POST', headers:{'Content-Type':'application/json', ...H},
        body: JSON.stringify({ officerId: Number(officerId), complaintIds: ids }),
      });
      const data = await res.json();
      const result = document.getElementById('result');
      result.classList.remove('hidden');
      if (data.success) {
        result.innerHTML = `‚úÖ ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô ${data.dispatched.length} ‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!<br>${data.dispatched.join(', ')}`;
        result.className = 'result success';
      } else {
        result.innerHTML = '‚ùå ' + (data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
        result.className = 'result error'; btn.disabled = false; btn.textContent = '‚úÖ ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å';
      }
    }
    init();
  </script>
</body>
</html>
