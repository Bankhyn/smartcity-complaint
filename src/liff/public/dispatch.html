<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏≠‡∏≠‡∏Å‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</title>
  <link rel="stylesheet" href="/liff/css/style.css">
</head>
<body>
  <div class="container">
    <h1>üìã ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</h1>
    <p id="deptName" style="text-align:center;color:#2196F3;font-weight:bold;margin-bottom:12px;"></p>
    <div id="taskList" class="task-list">
      <p class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
    </div>
    <button id="dispatchBtn" class="btn btn-primary hidden" onclick="doDispatch()">
      ‚úÖ ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (<span id="selectedCount">0</span> ‡∏á‡∏≤‡∏ô)
    </button>
    <div id="result" class="result hidden"></div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    let officerId = null;
    let tasks = [];

    async function init() {
      try {
        const config = await fetch('/api/config').then(r => r.json());
        await liff.init({ liffId: config.liffId, withLoginOnExternalBrowser: true });

        if (!liff.isLoggedIn()) {
          return;
        }

        // ‡∏î‡∏∂‡∏á officer ‡∏à‡∏≤‡∏Å LINE profile
        const profile = await liff.getProfile();
        const officerRes = await fetch(`/api/officers/${profile.userId}`);
        if (!officerRes.ok) {
          showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô ‡∏û‡∏¥‡∏°‡∏û‡πå /‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°');
          return;
        }
        const officer = await officerRes.json();
        officerId = officer.id;

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≠‡∏á
        const deptRes = await fetch('/api/officers/departments/list');
        if (deptRes.ok) {
          const depts = await deptRes.json();
          const dept = depts.find(d => d.id === officer.departmentId);
          if (dept) document.getElementById('deptName').textContent = `üè¢ ${dept.name}`;
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏≠‡∏á‡∏ô‡∏µ‡πâ
        const res = await fetch(`/api/tasks/pending/${officerId}`);
        tasks = await res.json();
        renderTasks();
      } catch (err) {
        showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
      }
    }

    function showError(msg) {
      document.getElementById('taskList').innerHTML = `<p class="error" style="color:#C62828;text-align:center;padding:20px;">${msg}</p>`;
    }

    function renderTasks() {
      const container = document.getElementById('taskList');
      if (tasks.length === 0) {
        container.innerHTML = '<p class="empty">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ ‚ú®</p>';
        return;
      }

      container.innerHTML = tasks.map(t => `
        <label class="task-card">
          <input type="checkbox" value="${t.id}" onchange="updateCount()">
          <div class="task-info">
            <div class="task-ref">${t.refId}</div>
            <div class="task-issue">${t.issue}</div>
            <div class="task-location">üìç ${t.location || '-'}</div>
            <div class="task-contact">üë§ ${t.contactName || '-'} ${t.contactPhone ? 'üìû ' + t.contactPhone : ''}</div>
          </div>
        </label>
      `).join('');

      document.getElementById('dispatchBtn').classList.remove('hidden');
    }

    function updateCount() {
      const checked = document.querySelectorAll('.task-card input:checked').length;
      document.getElementById('selectedCount').textContent = checked;
    }

    async function doDispatch() {
      const checked = Array.from(document.querySelectorAll('.task-card input:checked'));
      const complaintIds = checked.map(el => Number(el.value));

      if (complaintIds.length === 0) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏á‡∏≤‡∏ô');
        return;
      }

      const btn = document.getElementById('dispatchBtn');
      btn.disabled = true;
      btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';

      const res = await fetch('/api/tasks/dispatch', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ officerId: Number(officerId), complaintIds }),
      });
      const data = await res.json();

      const result = document.getElementById('result');
      result.classList.remove('hidden');
      if (data.success) {
        result.innerHTML = `‚úÖ ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô ${data.dispatched.length} ‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!<br>${data.dispatched.join(', ')}`;
        result.className = 'result success';
        setTimeout(() => { if (liff.isInClient()) liff.closeWindow(); }, 2000);
      } else {
        result.innerHTML = '‚ùå ' + (data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
        result.className = 'result error';
        btn.disabled = false;
        btn.textContent = '‚úÖ ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å';
      }
    }

    init();
  </script>
</body>
</html>
