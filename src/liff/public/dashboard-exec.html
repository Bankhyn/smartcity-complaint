<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard ‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</title>
  <link rel="stylesheet" href="/liff/css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <style>
    .container { max-width:960px; }
    .exec-header { background:linear-gradient(135deg,#283593,#3949AB); color:#fff; padding:24px; border-radius:12px; margin-bottom:16px; text-align:center; }
    .exec-header h1 { margin:0; font-size:1.3rem; }
    .exec-header .sub { opacity:.8; font-size:.85rem; margin-top:4px; }
    .kpi-row { display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:16px; }
    @media(max-width:600px){ .kpi-row { grid-template-columns:1fr 1fr; } }
    .kpi-card { background:#fff; border-radius:10px; padding:16px; text-align:center; box-shadow:0 1px 3px rgba(0,0,0,.1); }
    .kpi-card .number { font-size:2rem; font-weight:700; color:#283593; }
    .kpi-card .label { font-size:.8rem; color:#666; margin-top:4px; }
    .kpi-card.green .number { color:#4CAF50; }
    .chart-card { background:#fff; border-radius:10px; padding:16px; margin-bottom:16px; box-shadow:0 1px 3px rgba(0,0,0,.1); }
    .chart-card h3 { font-size:.95rem; color:#333; margin:0 0 12px; }
    .two-col { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px; }
    @media(max-width:600px){ .two-col { grid-template-columns:1fr; } }
    .dept-table { width:100%; border-collapse:collapse; font-size:.82rem; }
    .dept-table th { background:#283593; color:#fff; padding:10px 8px; text-align:left; }
    .dept-table td { padding:10px 8px; border-bottom:1px solid #eee; }
    .dept-table tr:hover { background:#E8EAF6; }
    .dept-table .clickable { cursor:pointer; }
    .status-badge { display:inline-block; padding:2px 8px; border-radius:12px; font-size:.72rem; font-weight:600; }
    .status-badge.pending { background:#FFF3E0; color:#E65100; }
    .status-badge.accepted { background:#E3F2FD; color:#1565C0; }
    .status-badge.dispatched { background:#F3E5F5; color:#6A1B9A; }
    .status-badge.completed { background:#E8F5E9; color:#2E7D32; }
    .status-badge.waiting { background:#FFF3E0; color:#E65100; }
    .status-badge.failed { background:#FFEBEE; color:#C62828; }
    .complaint-row { background:#fff; padding:10px; border-radius:8px; margin-bottom:6px; box-shadow:0 1px 2px rgba(0,0,0,.06); font-size:.85rem; }
    .complaint-row .ref { color:#2196F3; font-weight:700; font-size:.8rem; }
    .complaint-row .meta { color:#999; font-size:.75rem; margin-top:2px; }
    .progress-bar { height:6px; border-radius:3px; background:#eee; overflow:hidden; margin-top:4px; }
    .progress-bar .fill { height:100%; border-radius:3px; background:#4CAF50; }
    .satis-row { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:16px; }
    @media(max-width:600px){ .satis-row { grid-template-columns:1fr; } }
    .satis-card { background:#fff; border-radius:10px; padding:16px; text-align:center; box-shadow:0 1px 3px rgba(0,0,0,.1); }
    .satis-card .number { font-size:1.8rem; font-weight:700; color:#9C27B0; }
    .satis-card .stars { color:#FFC107; font-size:1.2rem; }
    .satis-card .label { font-size:.8rem; color:#666; margin-top:4px; }
    .satis-table { width:100%; border-collapse:collapse; font-size:.85rem; }
    .satis-table th { background:#9C27B0; color:#fff; padding:10px 8px; text-align:left; }
    .satis-table td { padding:10px 8px; border-bottom:1px solid #eee; }
    .rating-bar { display:inline-block; height:8px; border-radius:4px; background:#E1BEE7; }
    .rating-bar .fill { height:100%; border-radius:4px; background:#9C27B0; display:block; }
  </style>
</head>
<body>
  <div class="container">
    <div id="loading" class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î Dashboard...</div>
    <div id="content" class="hidden">
      <div class="exec-header">
        <h1><img src="logo-ppnr.png" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ" style="width:40px;height:40px;vertical-align:middle;border-radius:50%;margin-right:8px;">‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡∏ï‡∏≥‡∏ö‡∏•‡∏û‡∏•‡∏±‡∏ö‡∏û‡∏•‡∏≤‡∏ô‡∏≤‡∏£‡∏≤‡∏¢‡∏ì‡πå</h1>
        <div class="sub">Dashboard ‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</div>
      </div>
      <div class="kpi-row" id="kpiRow"></div>
      <div class="satis-row" id="satisRow"></div>
      <div class="chart-card"><h3>‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Å‡∏≠‡∏á</h3><canvas id="deptChart"></canvas></div>
      <div class="two-col">
        <div class="chart-card"><h3>‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (30 ‡∏ß‡∏±‡∏ô)</h3><canvas id="dailyChart"></canvas></div>
        <div class="chart-card"><h3>‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3><canvas id="monthlyChart"></canvas></div>
      </div>
      <div class="two-col">
        <div class="chart-card"><h3>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</h3><canvas id="platformChart"></canvas></div>
        <div class="chart-card"><h3>‡∏´‡∏°‡∏ß‡∏î‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h3><canvas id="categoryChart"></canvas></div>
      </div>
      <div class="chart-card"><h3>‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡∏≠‡∏á</h3><div style="overflow-x:auto;"><table class="dept-table" id="deptTable"></table></div></div>
      <div class="chart-card"><h3>‚≠ê ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≠‡∏á</h3><div style="overflow-x:auto;"><table class="satis-table" id="satisTable"></table></div></div>
      <div class="chart-card"><h3>‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3><div id="recentList"></div></div>
    </div>
    <div id="result" class="result hidden"></div>
  </div>
  <script>
    const token = new URLSearchParams(window.location.search).get('t') || '';
    const H = { 'ngrok-skip-browser-warning': '1' };
    const STATUS_LABELS = { pending:'‡∏£‡∏≠‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á', accepted:'‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß', dispatched:'‡∏≠‡∏≠‡∏Å‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô', completed:'‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', waiting:'‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', failed:'‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' };
    const STATUS_COLORS = ['#FF9800','#2196F3','#9C27B0','#4CAF50','#FFC107','#F44336'];
    const STATUS_KEYS = ['pending','accepted','dispatched','completed','waiting','failed'];

    async function init() {
      try {
        const authRes = await fetch(`/api/auth/verify?token=${token}`, { headers: H });
        const auth = await authRes.json();
        if (!auth.success || !auth.officerId) { showError(auth.error || '‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏'); return; }

        const res = await fetch(`/api/dashboard/executive?token=${token}`, { headers: H });
        const data = await res.json();
        if (data.error) { showError(data.error); return; }

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('content').classList.remove('hidden');
        renderAll(data);
      } catch (e) { showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message); }
    }

    function renderAll(d) {
      // KPI row
      document.getElementById('kpiRow').innerHTML = `
        <div class="kpi-card"><div class="number">${d.overall.totalComplaints}</div><div class="label">‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div>
        <div class="kpi-card"><div class="number">${d.overall.totalThisMonth}</div><div class="label">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div></div>
        <div class="kpi-card"><div class="number">${d.overall.totalToday}</div><div class="label">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div></div>
        <div class="kpi-card green"><div class="number">${d.overall.completionRate}%</div><div class="label">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div></div>`;

      // Satisfaction overview
      const sat = d.satisfaction || {};
      function starDisplay(rating) {
        if (!rating) return '<span style="color:#999">-</span>';
        const full = Math.floor(rating);
        const half = rating - full >= 0.5 ? 1 : 0;
        return '‚òÖ'.repeat(full) + (half ? '¬Ω' : '') + '‚òÜ'.repeat(5 - full - half);
      }
      document.getElementById('satisRow').innerHTML = `
        <div class="satis-card"><div class="number">${sat.totalResponses || 0}</div><div class="label">‡∏ú‡∏π‡πâ‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏ß‡∏à</div></div>
        <div class="satis-card"><div class="number">${sat.avgSystemRating ?? '-'}</div><div class="stars">${starDisplay(sat.avgSystemRating)}</div><div class="label">ü§ñ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡πâ‡∏≠‡∏á‡∏û‡∏•‡∏±‡∏ö‡∏û‡∏•‡∏≤‡∏ô‡∏≤‡∏£‡∏≤‡∏¢‡∏ì‡πå</div></div>
        <div class="satis-card"><div class="number">${sat.avgOfficerRating ?? '-'}</div><div class="stars">${starDisplay(sat.avgOfficerRating)}</div><div class="label">üë∑ ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</div></div>`;

      // Department stacked bar
      const deptNames = d.departmentSummary.map(s => s.departmentName.replace('‡∏Å‡∏≠‡∏á','').trim() || s.departmentName);
      const datasets = STATUS_KEYS.map((key, i) => ({
        label: STATUS_LABELS[key],
        data: d.departmentSummary.map(s => s[key] || 0),
        backgroundColor: STATUS_COLORS[i],
      }));
      new Chart(document.getElementById('deptChart'), {
        type: 'bar',
        data: { labels: deptNames, datasets },
        options: { plugins: { legend: { position:'bottom', labels: { font: { size: 10 } } } }, scales: { x: { stacked: true, ticks: { font: { size: 10 } } }, y: { stacked: true, beginAtZero: true, ticks: { stepSize: 1 } } } }
      });

      // Daily trend
      new Chart(document.getElementById('dailyChart'), {
        type: 'line',
        data: { labels: d.dailyTrend.map(r => r.date.slice(5)), datasets: [{ label:'‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á', data: d.dailyTrend.map(r => r.count), borderColor:'#3949AB', backgroundColor:'rgba(57,73,171,.1)', fill:true, tension:.3 }] },
        options: { plugins: { legend: { display: false } }, scales: { x: { ticks: { maxTicksLimit: 7, font: { size: 9 } } }, y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
      });

      // Monthly trend
      const monthLabels = d.monthlyTrend.map(r => { const [y,m] = r.month.split('-'); const months = ['','‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.']; return months[+m]+' '+(+y+543-2500); });
      new Chart(document.getElementById('monthlyChart'), {
        type: 'bar',
        data: { labels: monthLabels, datasets: [{ data: d.monthlyTrend.map(r => r.count), backgroundColor:'#5C6BC0' }] },
        options: { plugins: { legend: { display: false } }, scales: { x: { ticks: { font: { size: 9 } } }, y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
      });

      // Platform pie
      const platLabels = d.platformBreakdown.map(p => p.platform === 'line' ? 'LINE' : 'Facebook');
      const platColors = d.platformBreakdown.map(p => p.platform === 'line' ? '#06C755' : '#1877F2');
      new Chart(document.getElementById('platformChart'), {
        type: 'pie',
        data: { labels: platLabels, datasets: [{ data: d.platformBreakdown.map(p => p.count), backgroundColor: platColors }] },
        options: { plugins: { legend: { position:'bottom' } } }
      });

      // Category bar
      new Chart(document.getElementById('categoryChart'), {
        type: 'bar',
        data: { labels: d.topCategories.map(c => c.category.length > 12 ? c.category.slice(0,12)+'..' : c.category), datasets: [{ data: d.topCategories.map(c => c.count), backgroundColor:'#7986CB' }] },
        options: { indexAxis:'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } } }
      });

      // Department performance table
      document.getElementById('deptTable').innerHTML = `
        <tr><th>‡∏Å‡∏≠‡∏á</th><th>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th><th>‡∏£‡∏≠</th><th>‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</th><th>‡∏≠‡∏±‡∏ï‡∏£‡∏≤</th><th>‡∏ä‡πà‡∏≤‡∏á</th></tr>` +
        d.departmentSummary.map(s => `
          <tr class="clickable" onclick="openDept(${s.departmentId})">
            <td>${s.departmentName}</td>
            <td><b>${s.total}</b></td>
            <td>${s.pending}</td>
            <td>${s.completed}</td>
            <td>${s.completionRate}%<div class="progress-bar"><div class="fill" style="width:${s.completionRate}%"></div></div></td>
            <td>${s.activeOfficers}</td>
          </tr>`).join('');

      // Satisfaction by department table
      const satByDept = sat.byDepartment || [];
      document.getElementById('satisTable').innerHTML = `
        <tr><th>‡∏Å‡∏≠‡∏á</th><th>‡∏ú‡∏π‡πâ‡∏ï‡∏≠‡∏ö</th><th>‡∏£‡∏∞‡∏ö‡∏ö</th><th>‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</th></tr>` +
        (satByDept.length === 0
          ? '<tr><td colspan="4" style="text-align:center;color:#999;padding:20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>'
          : satByDept.map(s => {
            const sysBar = s.avgSystem ? `<div class="rating-bar" style="width:100px"><div class="fill" style="width:${s.avgSystem/5*100}%"></div></div> ${s.avgSystem}/5` : '-';
            const offBar = s.avgOfficer ? `<div class="rating-bar" style="width:100px"><div class="fill" style="width:${s.avgOfficer/5*100}%"></div></div> ${s.avgOfficer}/5` : '-';
            return `<tr><td>${s.departmentName}</td><td>${s.responses}</td><td>${sysBar}</td><td>${offBar}</td></tr>`;
          }).join(''));

      // Recent complaints
      document.getElementById('recentList').innerHTML = d.recentComplaints.length === 0
        ? '<p style="text-align:center;color:#999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á</p>'
        : d.recentComplaints.map(c => {
          const date = new Date(c.createdAt).toLocaleDateString('th-TH',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
          return `<div class="complaint-row">
            <span class="ref">${c.refId}</span> <span class="status-badge ${c.status}">${STATUS_LABELS[c.status]||c.status}</span>
            <div style="margin-top:4px;">${c.issue}</div>
            <div class="meta">${c.departmentName} | ${date}</div>
          </div>`;
        }).join('');
    }

    function openDept(deptId) {
      window.location.href = `/liff/dashboard.html?t=${token}&dept=${deptId}`;
    }

    function showError(msg) {
      document.getElementById('loading').classList.add('hidden');
      const r = document.getElementById('result');
      r.innerHTML = msg; r.className = 'result error'; r.classList.remove('hidden');
    }

    init();
  </script>
</body>
</html>
